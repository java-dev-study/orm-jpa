## Chapter03 영속성 관리

### 3.1 엔티티 매니저 팩토리와 엔티티 매니저

- 엔티티 매니저는 엔티티를 저장하고, 수정하고, 삭제하고, 조회하는 등 엔티티와 관련된 모든 일을 처리함
- 엔티티 매니저 팩토리는 엔티티 매니저를 만드는 공장으로, 한 개만 만들어서 애플리케이션 전체에서 공유함
  - **엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 안전하므로 서로 다른 스레드 간 공유가 가능하지만, 엔티티 매니저는 여러 스레드가 동시에 접근하면 동시성 문제가 발생하므로 스레드 간에 절대 공유하면 안됨**
  - 엔티티 매니저는 트랜잭션 시작 시 커넥션을 획득함

### 3.2 영속성 컨텍스트란?

- 엔티티 매니저로 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리함

- 영속성 컨텍스트는 엔티티 매니저 생성 시 하나 생성됨

  ```java
  // 엔티티 매니저를 사용해서 회원 엔티티를 영속성 컨텍스트에 저장함
  em.persist(member);
  ```

### 3.3 엔티티의 생명주기

- 비영속 : 영속성 컨텍스트와 전혀 관계가 없는 상태
- 영속 : 영속성 컨텍스트에 저장된 상태
- 준영속 : 영속성 컨텍스트에 저장되었다가 분리된 상태
- 삭제 : 삭제된 상태

### 3.4 영속성 컨텍스트의 특징

- 영속성 컨텍스트는 엔티티를 식별자 값으로 구분하기 때문에 영속 상태는 식별자 값이 반드시 있어야 함
- 트랜잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터베이스에 반영하는 것을 플러시라고 함
- 영속성 컨텍스트가 엔티티를 관리하면 좋은점
  - 1차 캐시
  - 동일성 보장
  - 트랜잭션을 지원하는 쓰기 지원
  - 변경 감지
  - 지연 로딩
- 영속성 컨텍스트 내부에는 1차 캐시가 있음
  - 1차 캐시키는 식별자 값으로 데이터베이스 기본키와 매핑
  - `em.find()` 호출 시 먼저 1차 캐시 조회 후 없으면, 엔티티 매니저는 데이터베이스를 조회해서 엔티티를 생성함 
    - 1차 캐시에 저장 후 영속 상태의 엔티티 반환
  - 영속성 컨텍스트는 성능상 이점과 엔티티의 동일성을 보장함
- 엔티티 매니저는 트랜잭션을 커밋하기 전까지 데이터베이스에 엔티티를 저장하지 않고 내부 쿼리 저장소에 쿼리를 저장함
  - 트랜잭션을 커밋할 때 모아둔 쿼리를 데이터베이스에 보내는데 이를 쓰기 지연이라고 함
  - 트랜잭션 커밋 시 엔티티 매니저는 영속성 컨텍스트를 플러시함
- 엔티티 수정 시 엔티티 조회 후 데이터만 변경하면 됨
  - 엔티티의 변경사항을 데이터베이스에 자동으로 반영하는 기능을 변경 감지라 함
  - 이 때, 변경 감지는 영속성 컨텍스트가 관리하는 영속 상태의 엔티티에만 적용됨
  - `em.remove()`에 삭제 대상 엔티티를 넘겨주면 쓰기 지연 SQL 저장소에 등록되고, 트랜잭션을 커밋해서 플러시를 호출하면 데이터베이스에 삭제 쿼리를 전달함

### 3.5 플러시

- 플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스에 반영함
- 영속성 컨텍스트를 플러시하는 방법 3가지
  - `em.flush()` 직접 호출
  - 트랜잭션 커밋 시 플러시 자동 호출
  - JPQL 쿼리 실행 시 플러시 자동 호출

### 3.6 준영속

- 준영속 상태는 영속 상태의 엔티티가 영속성 컨텍스트에서 분리된 상태임
- 준영속 상태로 만드는 방법 3가지
  - `em.detach(entity)` : 특정 엔티티만 준영속 상태로 전환
    - 1차 캐시 및 쓰기 지연 SQL 저장소에서 해당 엔티티를 관리하기 위한 모든 정보 제거
  - `em.clear()` : 영속성 컨텍스트 완전히 초기화
    - 영속성 컨텍스트에 있는 모든 것 초기화
  - `em.close()` : 영속성 컨텍스트 종료
    - 영속성 컨텍스트가 관리하던 영속 상태의 엔티티 모두 준영속 상태가 됨
  - 준영속 상태의 특징
    - 거의 비영속 상태에 가까움 -> 영속성 컨텍스트가 제공하는 어떠한 기능도 동작하지 않음
    - 식별자 값을 가지고 있음 -> 이미 한 번 영속 상태였기 때문
    - 지연 로딩을 할 수 없음 
  - 준영속 상태의 엔티티를 다시 영속 상태로 변경하기 위해서는 병합 사용
    - `merge()` 메서드는 준영속 상태의 엔티티를 받아서 새로운 영속 상태의 엔티티를 반환함
    - 병합은 준영속, 비영속 관계없이 식별자 값으로 엔티티 조회가 가능하면 조회해서 병합하고 그렇지 않으면 새로 생성해서 병합함

