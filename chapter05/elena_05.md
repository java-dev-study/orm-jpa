## 연관관계 매핑 기초

- **방향(Direction)**\
: 단방향, 양방향\
: 둘 중 한 쪽만 참조 → 단방향\
: 양쪽 모두 서로 참조 → 양방향\
: 객체 관계에만 존재하고 테이블 관계는 항상 양방향
- **다중성(Multiplicity)**\
: 다대일(N:1), 일대다(1:N), 일대일(1:1), 다대다(N:N)
- **연관관계의 주인(ownver)**\
: 객체를 양방향 연관관계로 만들면 연관관계의 주인을 정해야 함

---

**1. 단방향 연관관계**
- 참조를 통한 연관관계는 언제나 단방향
- 객체는 참조(주소)로 연관관계를 맺음 : 단반향
- 테이블은 외래 키고 연관관계를 맺음 : 양방향
- 객체를 양방향으로 참조하려면 단방향 연관관계를 2개 만들어야 함

1. 순수한 객체 연관관계
- 객체는 참조를 사용해서 연관관계 탐색 가능 : `객체 그래프 탐색`

2. 테이블 연관관계
- EB는 외래 키를 사용해서 연관관계 탐색 가능 : `조인`

3. 객체 관계 매핑
- `@ManyToOne` : 다대일(N:1) 관계, 연관관계 매핑 시 이렇게 다중성을 나타내는 Annotation 필수 사용
- `@JoinColumn(name="TEAM_ID")` : 외래 키 매핑 시 사용, `name` 속성에 매핑할 외래 키 이름 지정

4. @JoinColumn
- 외래 키 매핑 시 사용

5. @ManyToOne
- 다대일 관계에서 사용

---

**2. 연관관계 사용**
1. 저장
- 엔티티 저장 시 연관된 모든 엔티티는 영속 상태여야 함

2. 조회
- 연관관계가 있는 엔티티를 조회하는 방법
> - 객체 그래프 탐색
> - 객체지향 쿼리 사용

`객체 그래프 탐색`
- 객체를 통해 연관된 엔티티 조회

`객체지향 쿼리 사용`
- JPQL `cf. :로 시작하는 것은 파라미터를 바인딩받는 문법`
- 조인 지원

3. 수정
- 수정은 단순히 불러온 엔티티의 값만 변경해두면 플러시가 일어나면서 변경 감지 기능이 작동\
→ 변경사항을 DB에 자동 저장
- 연관관계를 수정할 때도 참조하는 대상만 변경하면 나머지는 JPA가 자동 처리

4. 연관관계 제거
- 연관관계를 null로 설정

5. 연관된 엔티티 삭제
- 기존에 있던 연관관계를 먼저 제거하고 삭제해야 함

---

**3. 양방향 연관관계**
- DB 테이블은 외래 키 하나로 양방향으로 조회 가능

1. 양방향 연관관계 매핑
- 일대다 관계 매핑을 위해 `@oneToMany` 매핑 정보 사용

2. 일대다 컬렉션 조회

---

**4. 연관관계의 주인**
- 엄밀히 말하면 객체에는 양방향 연관관계가 없음 → 서로 다른 단방향 연관관계 2개를 양방향인 것처럼 보이게 할 뿐
- 테이블은 외래 키 하나로 두 테이블의 연관관계를 관리
- 엔티티를 양방향 연관관계로 설정하면 객체의 참조는 둘인데 외래 키는 하나 → 둘 사이에 차이 발생
- 이런 차이로 인해 두 객체 연관관계 중 하나를 정해서 테이블의 외래 키를 관리하는 `연관관계의 주인` 규칙 존재

1. 양방향 매핑의 규칙: 연관관계의 주인
- `연관관계의 주인`만이 DB 연관관계와 매핑되고 외래 키 관리(등록, 수정, 삭제) 가능
- 반면 주인이 아닌 쪽은 읽기만 가능
- 어떤 연관관계를 주인으로 정할지 : `mappedBy` 속성 사용
- 주인은 `mappedBy` 속성을 사용하지 않음
- 주인이 아니면 `mappedBy` 속성을 사용해서 속성의 값으로 연관관계의 주인을 지정해야 함
- 연관관계의 주인을 정한다 == 외래 키 관리자를 선택하는 것

2. 연관관계의 주인은 외래 키가 있는 곳

---

**5. 양방향 연관관계 저장**
- 주인이 아닌 방향은 값을 설정하지 않아도 DB에 외래 키 값이 정상 입력됨

---

**6. 양방향 연관관계의 주의점**
1. 순수한 객체까지 고려한 양방향 연관관계
- 객체 객체 관점에서 양쪽 방향(연관관계의 주인/주인이 아닌 곳)에 모두 값을 입력해주는 것이 안전

2. 연관관계 편의 메소드
- 실수로 양방향 연관관계 둘 중 하나만 호출해서 양방향이 깨질 수도 있음
- `연관관계 편의 메소드` : 한 번에 양방향 관계를 설정하는 메소드

3. 연관관계 편의 메소드 작성 시 주의사항
