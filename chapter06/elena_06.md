## 6. 다양한 연관관계 매핑

- 다중성 : 왼쪽이 연관관계의 주인\
ex) `다대일 양방향` : 다(N)가 연관관계의 주인

---

**1. 다대일**
- `다대일` 관계의 반대 방향은 항상 `일대다` (그 반대도 마찬가지)
- DB 테이블의 일, 다 관계에서 외래 키는 항상 `다쪽`

1. 다대일 단방향 [N:1]
- 회원은 Member.team으로 팀 엔티티 참조 가능
- 반대로 팀에는 회원을 참조하는 필드가 X
```java
@ManyToOne
@JoinColumn(name = "TEAM_ID")
private Team team;
```

2. 다대일 양방향 [N:1, 1:N]
- 실선이 연관관계의 주인(Member.team)이고 점선(Team.members)은 연관관계의 주인이 아님

`양방향은 외래 키가 있는 쪽이 연관관계의 주인`
- JPA는 외래 키를 관리할 때 연관관계의 주인만 사용
- 주인이 아닌 쪽은 조회를 위한 JPQL이나 객체 그래프를 탐색할 때 사용

`양방향 연관관계는 항상 서로를 참조해야 함`
- 항상 서로 참조하게 하려면 `연관관계 편의 메소드`를 작성하는 것이 좋음
- 양쪽에 다 작성할 경우 무한푸르에 빠지므로 주의

---

**2. 일대다**
- `다대일` 관계의 반대 방향
- 엔티티를 하나 이상 참조할 수 있으므로 자바 컬렉션 중 하나를 사용\
(Collection, List, Set, Map)

1. 일대다 단방향 [1:N]
- 보통 자신이 매핑한 테이블의 외래 키를 관리하는데, 이 매핑은 반대쪽 테이블에 있는 외래 키를 관리
- `@JoinColumn` 명시

`단점`
- 매핑한 객체가 관리하는 외래 키가 다른 테이블에 있음
- 연관관계 처리를 위해 UPDATE SQL를 추가로 실행해야 함

`일대다 단방향 매핑보다는 다대일 양방향 매핑을 사용하자`
- 관리해야 하는 외래 키가 본인 테이블에 있어 `일대다 단방향` 매핑 같은 문제가 발생하지 않음

2. 일대다 양방향 [1:N, N:1]
- 일대다 양방향 매핑은 존재하지 않음\
→ 다대일 양방향 매핑을 사용해야 함
- 정확히는 양방향 매핑에서 `@OneToMany`는 연관관계 주인이 될 수 없음
- `일대다 단방향` 매핑 반대편에 같은 외래 키를 사용하는 `다대일 단방향` 매핑을 읽기 전용으로 하나 추가하면 `일대다 양방향` 매핑이 가능

---

**3. 일대일 [1:1]**
- 양쪽이 서로 하나의 관계만 가짐

`특징`
- 그 반대도 `일대일 관계`
- 테이블 관계에서 일댇, 다대일은 항항 `다(N)쪽`이 외래 키를 가짐
- `일대일 관계`는 주 테이블이나 대상 테이블 중 어느 곳이나 외래 키를 가질 수 있음

1. 주 테이블에 외래 키
- 주 객체가 대상 객체를 참조하는 것처럼 주 테이블에 외래 키를 두고 대상 테이블을 참조
- 객체 참조와 비슷하게 사용 가능
- 주 테이블이 외래 키를 가지고 있으므로 주 테이블만 확인해도 대상 테이블과 연관관계가 있는지 확인 가능

`단방향`
- `@OneToOne` 사용
- 다대일 양방향(`@ManyToOne`)과 거의 비슷

`양방향`

2. 대상 테이블에 외래 키
- 테이블 관계를 일대일에서 `일대다로 변경`할 때 테이블 구조 그대로 유지 가능

`단방향`
- 대상 테이블에 외래 키가 있는 단방향 간계는 JPA에서 지원하지 않음
- 단방향 관계를 Locker에서 Member 방향으로 수정하거나 양방향 관계로 만들고 Locker를 연관관계의 주인으로 설정

`양방향`
- 주 엔티티 대신에 대상 엔티티를 연관관계의 주인으로 만들어서 테이블의 외래 키를 관리하도록 함

---

**4. 다대다**
- 정규화된 테이블은 2개로 `다대다` 관계 표현 불가
→ 일대다, 다대일 관계로 풀어내는 연결 테이블 사용
- 객체는 테이블과 다르게 객체 2개로 `다대다` 관계 표현 가능

1. 다대다: 단방향
- `@ManyToMany`, `@JoinTable`
`@JoinTable`
- `name` : 연결 테이블 지정
- `joinClumns` : 현재 방향과 매핑할 조인 컬럼 정보 지정
- `inverseJoinColumns` : 반대 방향과 매핑할 조인 컬럼 정보 지정

2. 다대다: 양방향
- 역방항도 `@ManyToMany` 사용
- 양쪽 중 원하는 곳에 mappedBy로 연관관계의 주인을 지정

3. 다대다: 매핑의 한계와 극복, 연결 엔티티 사용
- `@ManyToMany`를 실무에서 사용하기에는 한계가 있음

`복합 기본 키`
- `@Id`와 `@JoinColumn`을 동시에 사용 및 `@IdClass` 사용
- `복합키`는 별도의 식별자 클래스로 만들어야 함
- `Serializable`을 구현해야 함
- `equals`와 `hashCode` 메소드를 구현해야 함
- 기본 생성자가 있어야 함
- 식별자 클래스는 public이어야 함
- `@IdClass`를 사용하는 방법 외에 `@EmbeddedId`를 사용하는 방법도 있음

`식별 관계`
- 부모 테이블의 기본 키를 받아서 자신의 기본 키 + 외래 키로 사용하는 것

4. 다대다: 새로운 기본 키 사용
- DB에서 자동으로 생성해주는 대리 키를 Long 값으로 사용
- 간편하고 거의 영구히 사용 가능하며 비즈니스에 의존하지 않음
- ORM 매핑 시 복합 키를 만들지 않아도 되므로 간단한 매핑 완성

5. 다대다 연관관계 정리
- **식별 관계** : 받아온 식별자를 기본 키 + 외래 키로 사용
- **비식별 관계** : 받아온 식별자는 외래 키로만 사용하고 새로운 식별자를 추가
- `다대다` 관계를 `일대다 다대일` 관계로 풀어내기 위해 연결 테이블을 만들 때 식별자를 어떻게 구성할지 위에서 선택
